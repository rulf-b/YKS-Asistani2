{% extends "layout.html" %}
{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0 text-primary"><i class="bi bi-search me-2"></i> Yeni Soru Analizi</h2>
    </div>
    <p class="text-muted mb-4">Aşağıdaki metin kutusuna soruyu yazabilir veya doğrudan sorunun fotoğrafını yükleyebilirsiniz.</p>

    <form method="POST" action="" enctype="multipart/form-data" id="analiz-form" class="mb-5 p-4 card shadow-sm" novalidate>
        <div class="mb-3">
            <label for="soru_resmi" class="form-label fw-bold">Soru Resmini Yükle:</label>
            <input type="file" class="form-control" name="soru_resmi" id="soru_resmi" accept="image/png, image/jpeg, image/jpg">
            <div class="invalid-feedback" id="soru_resmi_feedback">
                Lütfen sorunun resmini yükleyin veya metin olarak yazın.
            </div>
        </div>
        <p class="text-center fw-bold my-3 text-muted">VEYA</p>
        <div class="mb-3">
            <label for="soru" class="form-label fw-bold">Soruyu Metin Olarak Yaz:</label>
            <textarea class="form-control" name="soru" id="soru" rows="6" placeholder="Sorunuzu buraya yazın..."></textarea>
            <div class="invalid-feedback" id="soru_metni_feedback">
                Lütfen soruyu metin olarak girin veya resim yükleyin.
            </div>
        </div>
        <div class="mb-4">
            <label for="cevap" class="form-label fw-bold">Kendi Cevabın veya Düşüncelerin (isteğe bağlı):</label>
            <textarea class="form-control" name="cevap" id="cevap" rows="3" placeholder="Cevabınızı veya düşüncelerinizi buraya yazabilirsiniz..."></textarea>
        </div>
        <div class="d-grid">
            <button type="submit" class="btn btn-primary btn-lg" id="analiz-butonu"><i class="bi bi-magic me-2"></i> Analiz İste</button>
        </div>
    </form>

    {% if benzer_sorular %}
    <div class="mt-5 p-4 rounded-3 card shadow-sm" style="background-color: var(--secondary-light);">
        <h3 class="mb-3 text-warning"><i class="bi bi-lightbulb-fill me-2"></i> Bu Konuyla İlgili Diğer Sorular</h3>
        <p class="text-muted mb-4">Bu konuyu pekiştirmek için veritabanımızdaki diğer kullanıcılar tarafından sorulmuş benzer sorulara göz atabilirsin.</p>
        <div class="list-group list-group-flush border-0">
            {% for benzer_soru in benzer_sorular %}
                <div class="list-group-item list-group-item-action border-0 rounded-3 mb-2" style="background-color: var(--card-bg); box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <p class="mb-1"><strong>Soru:</strong> {{ benzer_soru.soru_metni }}</p>
                    <small class="text-muted">Soran: {{ benzer_soru.author.username }}</small>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <hr class="my-5">

    <h2 class="mt-4 text-primary"><i class="bi bi-clock-history me-2"></i> Geçmiş Soru Analizlerin</h2>
    <div class="accordion mt-3" id="gecmisAnalizlerAccordion">
        {% if gecmis_analizler %}
            {% for analiz in gecmis_analizler %}
                <div class="accordion-item card shadow-sm mb-2 rounded-3">
                    <h2 class="accordion-header" id="heading-{{ analiz.id }}">
                        <button class="accordion-button collapsed rounded-3 fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ analiz.id }}">
                            <strong>Soru: {{ analiz.soru_metni[:80] }}...</strong>&nbsp; <small class="text-muted ms-auto">({{ analiz.tarih.strftime('%d %b %Y') }})</small>
                        </button>
                    </h2>
                    <div id="collapse-{{ analiz.id }}" class="accordion-collapse collapse" data-bs-parent="#gecmisAnalizlerAccordion">
                        <div class="accordion-body" style="white-space: pre-wrap; background-color: #f8f9fa;">
                            <p class="fw-bold text-dark"><u>Soru Metni:</u></p>
                            <p class="text-muted">{{ analiz.soru_metni }}</p>
                            {% if analiz.cevap_metni %}<p class="fw-bold text-dark mt-3"><u>Senin Cevabın:</u></p><p class="text-muted">{{ analiz.cevap_metni }}</p>{% endif %}
                            <hr class="my-3">
                            <p class="fw-bold text-dark"><u>Yapay Zekâ Analizi:</u></p>
                            <div class="analiz-icerik">{{ analiz.analiz_sonucu|markdown }}</div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            {# YENİ: Boş Durum Tasarımı #}
            <div class="text-center my-4 p-4 card shadow-sm text-muted">
                <i class="bi bi-search display-4 mb-3"></i>
                <h4 class="card-title text-muted">Henüz analiz edilmiş bir sorun bulunmuyor!</h4>
                <p class="card-text">YKS koçunuzdan hemen ilk analizi yapın ve eksiklerinizi belirleyin.</p>
            </div>
        {% endif %}
    </div>

    <script>
        const analizForm = document.getElementById('analiz-form');
        const analizButonu = document.getElementById('analiz-butonu');
        const soruMetniInput = document.getElementById('soru');
        const soruResmiInput = document.getElementById('soru_resmi');

        if(analizForm){
            analizForm.addEventListener('submit', function(event) {
                let isValid = true;

                // Hem metin hem de resim boşsa uyarı ver
                if (soruMetniInput.value.trim() === '' && soruResmiInput.files.length === 0) {
                    soruMetniInput.classList.add('is-invalid');
                    soruResmiInput.classList.add('is-invalid');
                    isValid = false;
                } else {
                    // Eğer en az biri doluysa, is-invalid'i kaldır
                    soruMetniInput.classList.remove('is-invalid');
                    soruResmiInput.classList.remove('is-invalid');
                }

                if (!isValid) {
                    event.preventDefault(); // Formu göndermeyi engelle
                    analizForm.classList.add('was-validated'); 
                } else {
                    // Form geçerliyse butonu devre dışı bırak ve genel spinner'ı göster
                    analizButonu.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Analiz Ediliyor...';
                    analizButonu.disabled = true;
                    analizButonu.classList.add('btn-secondary');
                    analizButonu.classList.remove('btn-primary');
                    
                    showLoadingSpinner(); // layout.html'deki fonksiyonu çağırıyoruz
                }
            });

            // Input alanlarından biri değiştiğinde is-invalid'i kaldırma
            soruMetniInput.addEventListener('input', function() {
                if (soruMetniInput.value.trim() !== '') {
                    soruMetniInput.classList.remove('is-invalid');
                    soruResmiInput.classList.remove('is-invalid'); // Diğerini de kaldır
                    analizForm.classList.remove('was-validated'); // Validasyon durumunu sıfırla
                }
            });

            soruResmiInput.addEventListener('change', function() {
                if (soruResmiInput.files.length > 0) {
                    soruMetniInput.classList.remove('is-invalid');
                    soruResmiInput.classList.remove('is-invalid'); // Diğerini de kaldır
                    analizForm.classList.remove('was-validated'); // Validasyon durumunu sıfırla
                }
            });
        }
    </script>
{% endblock content %}