{% extends "layout.html" %}
{% block content %}
<div class="container">
    <div class="px-4 py-5 text-center">
        <h1 class="display-5 fw-bold">
            {% if user %}
                Merhaba, {{ user.username }}! ğŸ‘‹
            {% else %}
                HoÅŸ geldiniz! ğŸ‘‹
            {% endif %}
        </h1>
        <div class="col-lg-8 mx-auto">
            <p class="lead mb-4 text-muted">YKS AsistanÄ± panona hoÅŸ geldin. Hedeflerine bir adÄ±m daha yaklaÅŸmak iÃ§in bugÃ¼n ne yapmak istersin?</p>
            {% if hedef %}
                <div class="alert alert-success" role="alert">
                    <h4 class="alert-heading"><i class="bi bi-bullseye me-2"></i> Hedefin:</h4>
                    <p class="mb-0 fs-5"><strong>{{ hedef.universite }} - {{ hedef.bolum }}</strong></p>
                    <hr>
                    <a href="/hedef_analizi" class="btn btn-success"><i class="bi bi-graph-up-arrow me-2"></i> DetaylÄ± Hedef Analizimi GÃ¶rÃ¼ntÃ¼le</a>
                    
                    {# YENÄ°: Ä°lerleme Ã‡ubuklarÄ±/GÃ¶stergeler #}
                    <div class="mt-4">
                        <h5 class="fw-bold text-dark mb-3">Hedef Ä°lerlemen:</h5>
                        <div class="mb-2">
                            <label class="form-label">TYT Net Ä°lerlemesi (Hedef: {{ hedef.hedef_tyt_net | round(2) }})</label>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-primary" role="progressbar" 
                                     style="width: {{ tyt_ilerleme_yuzde }}%;" 
                                     aria-valuenow="{{ tyt_ilerleme_yuzde }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ current_user_tyt_net | default(0) | round(2) }} Net (%{{ tyt_ilerleme_yuzde | round(1) }})
                                </div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">AYT Net Ä°lerlemesi (Hedef: {{ hedef.hedef_ayt_net | round(2) }})</label>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-info" role="progressbar" 
                                     style="width: {{ ayt_ilerleme_yuzde }}%;" 
                                     aria-valuenow="{{ ayt_ilerleme_yuzde }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ current_user_ayt_net | default(0) | round(2) }} Net (%{{ ayt_ilerleme_yuzde | round(1) }})
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            {% else %}
                <div class="alert alert-warning">
                    <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i> HenÃ¼z bir hedefin yok!</h4>
                    <p>Motivasyonunu artÄ±rmak ve yol haritanÄ± Ã§izmek iÃ§in hemen bir hedef belirle.</p>
                    <a href="/hedef_belirle" class="btn btn-warning"><i class="bi bi-pin-map-fill me-2"></i> Hemen Hedef Belirle</a>
                </div>
            {% endif %}
        </div>
    </div>

    {# YENÄ°: Ã–zet Kartlar #}
    <div class="row g-4 mb-5">
        <div class="col-lg-4 col-md-6">
            <div class="card h-100 shadow-sm text-center bg-primary text-white" style="background-color: var(--primary-dark) !important;">
                <div class="card-body d-flex flex-column justify-content-center">
                    <i class="bi bi-stopwatch-fill display-4 mb-3"></i>
                    <h5 class="card-title fw-bold">Toplam Ã‡alÄ±ÅŸma SÃ¼resi</h5>
                    <p class="card-text fs-2 mb-0">{{ toplam_calisma_suresi_saat | round(1) }} saat</p>
                    <small class="text-white-50 mt-1">({{ toplam_calisma_suresi_dakika }} dakika)</small>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="card h-100 shadow-sm text-center bg-success text-white" style="background-color: var(--success-soft) !important;">
                <div class="card-body d-flex flex-column justify-content-center">
                    <i class="bi bi-question-circle-fill display-4 mb-3"></i>
                    <h5 class="card-title fw-bold">Analiz Edilen Toplam Soru</h5>
                    <p class="card-text fs-2 mb-0">{{ toplam_analiz_edilen_soru }} adet</p>
                    <small class="text-white-50 mt-1">Yapay zeka ile</small>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-12">
            <div class="card h-100 shadow-sm text-center bg-warning text-dark" style="background-color: var(--warning-soft) !important;">
                <div class="card-body d-flex flex-column justify-content-center">
                    <i class="bi bi-exclamation-octagon-fill display-4 mb-3"></i>
                    <h5 class="card-title fw-bold">Eksik Konu SayÄ±sÄ±</h5>
                    <p class="card-text fs-2 mb-0">{{ tekrar_konu_sayisi }} adet</p>
                    <small class="text-dark-50 mt-1">Tekrar listende bekliyor</small>
                </div>
            </div>
        </div>
    </div>


    <div class="row g-4 mb-5">
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-primary"><i class="bi bi-search me-2"></i> Son Soru Analizlerin</h5>
                    {% if analizler %}
                        <ul class="list-group list-group-flush border-0">
                            {% for analiz in analizler %}
                                <li class="list-group-item d-flex justify-content-between align-items-center border-0 py-2">
                                    <span class="text-truncate">{{ analiz.soru_metni[:60] }}...</span> 
                                    <small class="text-muted ms-auto">({{ analiz.tarih.strftime('%d %b') }})</small>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        {# YENÄ°: BoÅŸ Durum TasarÄ±mÄ± #}
                        <div class="text-center my-4 p-4 text-muted">
                            <i class="bi bi-exclamation-circle-fill display-4 mb-3"></i>
                            <p class="card-text">HenÃ¼z analiz edilmiÅŸ soru yok.</p>
                            <p class="fw-bold">Hemen ilk analizi yap, YKS'ye bir adÄ±m Ã¶nde baÅŸla!</p>
                        </div>
                    {% endif %}
                    <a href="/soru-analizi" class="btn btn-outline-primary mt-auto"><i class="bi bi-plus-circle me-2"></i> Yeni Soru Analizi Yap</a>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-primary"><i class="bi bi-bar-chart-line-fill me-2"></i> Son Denemelerin</h5>
                    {% if denemeler %}
                        <ul class="list-group list-group-flush border-0">
                            {% for deneme in denemeler %}
                                <li class="list-group-item d-flex justify-content-between align-items-center border-0 py-2">
                                    <span class="text-truncate">{{ deneme.kaynak }}</span> 
                                    <small class="text-muted ms-auto">({{ deneme.tarih.strftime('%d %b') }})</small>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        {# YENÄ°: BoÅŸ Durum TasarÄ±mÄ± #}
                        <div class="text-center my-4 p-4 text-muted">
                            <i class="bi bi-bar-chart-fill display-4 mb-3"></i>
                            <p class="card-text">HenÃ¼z kaydedilmiÅŸ deneme yok.</p>
                            <p class="fw-bold">PerformansÄ±nÄ± takip etmek iÃ§in ilk denemeni ekle!</p>
                        </div>
                    {% endif %}
                     <a href="/deneme_takibi" class="btn btn-outline-primary mt-auto"><i class="bi bi-plus-circle me-2"></i> Yeni Deneme Ekle</a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row g-4 mb-5">
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-primary"><i class="bi bi-clock-fill me-2"></i> Son Ã‡alÄ±ÅŸma OturumlarÄ±n</h5>
                    {% if calisma_oturumleri %}
                        <ul class="list-group list-group-flush border-0">
                            {% for oturum in calisma_oturumleri %}
                                <li class="list-group-item d-flex justify-content-between align-items-center border-0 py-2">
                                    <span class="text-truncate">{{ oturum.konu_adi if oturum.konum_adi else 'Belirtilmedi' }} ({{ oturum.calisma_suresi_dakika }} dk)</span> 
                                    <small class="text-muted ms-auto">({{ oturum.tarih.strftime('%d %b') }})</small>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        {# YENÄ°: BoÅŸ Durum TasarÄ±mÄ± #}
                        <div class="text-center my-4 p-4 text-muted">
                            <i class="bi bi-clock-history display-4 mb-3"></i>
                            <p class="card-text">HenÃ¼z kaydedilmiÅŸ bir Ã§alÄ±ÅŸma oturumu yok.</p>
                            <p class="fw-bold">Ã‡alÄ±ÅŸma alÄ±ÅŸkanlÄ±klarÄ±nÄ± takip etmeye baÅŸla!</p>
                        </div>
                    {% endif %}
                    <a href="/calisma_takibi" class="btn btn-outline-primary mt-auto"><i class="bi bi-plus-circle me-2"></i> Ã‡alÄ±ÅŸma Oturumu Ekle</a>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
             <div class="card h-100 shadow-sm text-center">
                <div class="card-body d-flex flex-column justify-content-center">
                     <h5 class="card-title text-warning mb-3"><i class="bi bi-lightbulb-fill me-2"></i> Eksiklerini Gider</h5>
                     <p class="card-text fs-6 text-muted mb-4">Bilgi eksikliÄŸi yaÅŸadÄ±ÄŸÄ±n **{{tekrar_konu_sayisi}}** konu tekrar listende seni bekliyor. Hemen bir quiz Ã§Ã¶zerek kendini test et ve eksiklerini kapat!</p>
                     <a href="/mini_quiz" class="btn btn-warning btn-lg mt-auto"><i class="bi bi-card-checklist me-2"></i> Mini Quiz BaÅŸlat</a>
                </div>
             </div>
        </div>
    </div>

    <!-- Grafikler Row -->
    <div class="row g-4 mb-5 fade-in" data-aos="fade-up">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-primary"><i class="bi bi-bar-chart-fill me-2"></i> HaftalÄ±k Ã‡alÄ±ÅŸma SÃ¼resi</h5>
                    <canvas id="studyChart" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-primary"><i class="bi bi-pie-chart-fill me-2"></i> Net Ä°lerlemesi</h5>
                    <canvas id="netChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{# --- Grafikler --- #}
{% block extra_scripts %}
<script>
    // HaftalÄ±k Ã§alÄ±ÅŸma verileri (dakika) - henÃ¼z gerÃ§ek zamanlÄ± deÄŸil
    window.weekData = {{ haftalik_calisma | default([0,0,0,0,0,0,0]) }};
    // Net ilerlemeleri
    window.netData = [{{ current_user_tyt_net | default(0) }}, {{ current_user_ayt_net | default(0) }}];
</script>
<script src="/static/js/dashboard.js"></script>
{% endblock extra_scripts %}